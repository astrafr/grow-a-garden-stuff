<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow-A-Garden Tracker</title>
<style>
  body {
    background: #000;
    color: #a474ff;
    font-family: Arial, sans-serif;
    margin: 0; padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  #restock-timer {
    font-size: 4rem;
    font-weight: bold;
    margin-bottom: 1rem;
    user-select: none;
    text-shadow: 0 0 15px #8e44ad;
  }
  #buttons button {
    margin: 0 8px;
    padding: 8px 16px;
    font-size: 1.1rem;
    border-radius: 8px;
    border: 2px solid #9b59b6;
    background: transparent;
    color: #bb80ff;
    cursor: pointer;
  }
  #buttons button.active {
    background: #8e44ad;
    color: #fff;
    box-shadow: 0 0 10px #8e44adaa;
    border-color: #8e44ad;
  }
  #toggle-out-stock {
    margin: 1rem 0;
    padding: 6px 14px;
    border-radius: 8px;
    border: 2px solid #bb80ff;
    background: transparent;
    color: #bb80ff;
    cursor: pointer;
  }
  #content, #out-stock-list {
    max-width: 700px;
    width: 100%;
    background: #1a0d38;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 0 20px #8e44ad99;
    user-select: none;
    margin-bottom: 1rem;
    max-height: 400px;
    overflow-y: auto;
  }
  .item {
    display: flex;
    justify-content: space-between;
    padding: 0.4rem 0;
    border-bottom: 1px solid #4b297b;
  }
  .item:last-child { border-bottom: none; }
  .in-stock { color: #7df57d; font-weight: 700; }
  .out-stock { color: #ff7777; font-style: italic; }
  #last-updated {
    color: #b594ff;
    font-style: italic;
    user-select: none;
  }
  #error {
    color: #ff6666;
    margin-top: 0.5rem;
    user-select: none;
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20%,60% { transform: translateX(-10px); }
    40%,80% { transform: translateX(10px); }
  }
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  .flash-red {
    background-color: #7e1a1a !important;
    transition: background-color 0.3s ease;
  }
</style>
</head>
<body>

<h1 style="color:#bb80ff; user-select:none;">üå± Grow-A-Garden Tracker</h1>
<div id="restock-timer">0</div>

<div id="buttons">
  <button id="btn-seeds" class="active">Seeds</button>
  <button id="btn-gear">Gear</button>
</div>

<button id="toggle-out-stock">Show Out-of-Stock Items</button>

<div id="content">Loading...</div>
<div id="out-stock-list" style="display:none;"></div>

<div id="last-updated"></div>
<div id="error"></div>

<script>
  const API_URL = 'https://corsproxy.io/?https://gagstock.gleeze.com/grow-a-garden';

  // Rare seeds to notify
  const RARE_SEEDS = new Set([
    "Beanstalk",
    "Ember Lily",
    "Sugar Apple",
    "Burning Bud",
    "Blueberry"
  ]);

  // Fixed gear and seed names for ordering
  const FIXED_GEAR = [
    "Master Sprinkler", "Cleaning Spray", "Favorite Tool", "Harvest Tool", "Friendship Pot",
    "Godly Sprinkler", "Advanced Sprinkler", "Basic Sprinkler",
    "Trowel", "Recall Wrench", "Watering Can"
  ];
  const FIXED_SEEDS = [
    "Carrot", "Strawberry", "Blueberry", "Orange Tulip", "Tomato", "Daffodil", "Watermelon",
    "Pumpkin", "Apple", "Bamboo", "Coconut", "Cactus", "Dragon Fruit", "Mango", "Grape",
    "Mushroom", "Pepper", "Cacao", "Beanstalk", "Ember Lily", "Sugar Apple", "Burning Bud"
  ];

  let notified = new Set();
  let lastSeen = JSON.parse(localStorage.getItem('lastSeen') || '{}');

  const restockTimerEl = document.getElementById('restock-timer');
  const contentEl = document.getElementById('content');
  const outStockEl = document.getElementById('out-stock-list');
  const lastUpdatedEl = document.getElementById('last-updated');
  const errorEl = document.getElementById('error');
  const btnSeeds = document.getElementById('btn-seeds');
  const btnGear = document.getElementById('btn-gear');
  const toggleOutStockBtn = document.getElementById('toggle-out-stock');

  let currentCategory = 'seed';
  let showOutStock = false;
  let currentData = null;
  let restockSeconds = 0;
  let timerInterval = null;

  btnSeeds.onclick = () => {
    currentCategory = 'seed';
    btnSeeds.classList.add('active');
    btnGear.classList.remove('active');
    render(currentData);
  };
  btnGear.onclick = () => {
    currentCategory = 'gear';
    btnGear.classList.add('active');
    btnSeeds.classList.remove('active');
    render(currentData);
  };
  toggleOutStockBtn.onclick = () => {
    showOutStock = !showOutStock;
    outStockEl.style.display = showOutStock ? 'block' : 'none';
    toggleOutStockBtn.textContent = showOutStock ? 'Hide Out-of-Stock Items' : 'Show Out-of-Stock Items';
  };

  function timeAgo(ts) {
    if (!ts) return 'never';
    const diff = Date.now() - ts;
    const s = Math.floor(diff / 1000);
    if (s < 60) return s + 's ago';
    if (s < 3600) return Math.floor(s/60) + 'm ago';
    if (s < 86400) return Math.floor(s/3600) + 'h ago';
    return Math.floor(s/86400) + 'd ago';
  }

  function updateLastSeen(category, items) {
    const now = Date.now();
    items.forEach(item => {
      if (item.quantity > 0) {
        lastSeen[category + ':' + item.name] = now;
      } else if (!lastSeen[category + ':' + item.name]) {
        lastSeen[category + ':' + item.name] = null;
      }
    });
    localStorage.setItem('lastSeen', JSON.stringify(lastSeen));
  }

  function shakeScreen() {
    document.body.classList.add('flash-red', 'shake');
    setTimeout(() => document.body.classList.remove('shake'), 500);
    setTimeout(() => document.body.classList.remove('flash-red'), 1000);
  }

  function notify(item) {
    if (Notification.permission === 'granted') {
      new Notification('Rare Seed In Stock!', {
        body: `${item.name} is available x${item.quantity}`,
        icon: 'https://em-content.zobj.net/source/twitter/376/glowing-star_1f31f.png'
      });
      shakeScreen();
    }
  }

  function checkNotifications(data) {
    if (!data) return;
    const items = data[currentCategory]?.items || [];
    items.forEach(item => {
      if (RARE_SEEDS.has(item.name) && item.quantity > 0 && !notified.has(item.name)) {
        notify(item);
        notified.add(item.name);
      }
    });
  }

  function getNextRestock(data) {
    if (!data) return 0;
    let times = [];
    ['seed', 'gear'].forEach(cat => {
      if (data[cat]?.items) {
        data[cat].items.forEach(i => {
          if (typeof i.restock_seconds === 'number' && i.restock_seconds > 0) {
            times.push(i.restock_seconds);
          }
        });
      }
    });
    return times.length ? Math.min(...times) : 0;
  }

  function render(data) {
    if (!data) {
      contentEl.textContent = 'Failed to load stock.';
      outStockEl.style.display = 'none';
      toggleOutStockBtn.style.display = 'none';
      lastUpdatedEl.textContent = '';
      return;
    }
    currentData = data;

    toggleOutStockBtn.style.display = 'inline-block';

    const seedMap = new Map((data.seed?.items || []).map(i => [i.name, i]));
    const gearMap = new Map((data.gear?.items || []).map(i => [i.name, i]));

    const list = currentCategory === 'seed' ? FIXED_SEEDS : FIXED_GEAR;
    const map = currentCategory === 'seed' ? seedMap : gearMap;

    const items = list.map(name => {
      const item = map.get(name);
      return {
        name,
        quantity: item ? item.quantity : 0,
      };
    });

    updateLastSeen(currentCategory, items);

    const inStock = items.filter(i => i.quantity > 0);
    const outStock = items.filter(i => i.quantity <= 0);

    contentEl.innerHTML = inStock.length
      ? inStock.map(i => `<div class="item in-stock">${i.name} <span>‚úÖ x${i.quantity}</span></div>`).join('')
      : '<div>No items in stock.</div>';

    outStockEl.innerHTML = outStock.length
      ? outStock.map(i => {
          const last = lastSeen[currentCategory + ':' + i.name];
          return `<div class="item out-stock">${i.name} <span>‚ùå Last seen ${timeAgo(last)}</span></div>`;
        }).join('')
      : '<div>No out-of-stock items.</div>';

    if (!showOutStock) outStockEl.style.display = 'none';

    lastUpdatedEl.textContent = `Last updated: ${new Date(data.updated_at || Date.now()).toLocaleTimeString()}`;

    checkNotifications(data);
  }

  async function fetchData() {
    try {
      errorEl.textContent = '';
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const json = await res.json();
      return json.data;
    } catch(e) {
      errorEl.textContent = 'Error loading data. See console.';
      console.error(e);
      return null;
    }
  }

  async function update() {
    const data = await fetchData();
    if (!data) {
      restockSeconds = 0;
      restockTimerEl.textContent = restockSeconds;
      return;
    }
    restockSeconds = getNextRestock(data);
    restockTimerEl.textContent = restockSeconds;
    render(data);
  }

  async function start() {
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      await Notification.requestPermission();
    }
    await update();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(async () => {
      restockSeconds--;
      if (restockSeconds < 0) {
        await update();
      } else {
        restockTimerEl.textContent = restockSeconds;
      }
    }, 1000);
  }

  start();
</script>

</body>
</html>
