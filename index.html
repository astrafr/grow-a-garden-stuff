<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow-A-Garden Tracker</title>
<style>
  body {
    background: #000;
    color: #a474ff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 2rem;
    margin: 0;
    text-align: center;
    overflow-x: hidden;
    transition: background-color 0.5s ease;
  }
  h1 {
    font-size: 2.5rem;
    color: #bb80ff;
    text-shadow: 0 0 8px #9b59b6;
  }
  #restock-timer {
    font-size: 2.5rem;
    font-weight: bold;
    color: #fff;
    margin: 1rem 0 2rem 0;
    text-shadow: 0 0 8px #8e44ad;
  }
  #toggle-outstock {
    margin-bottom: 2rem;
    cursor: pointer;
    background: transparent;
    border: 2px solid #8e44ad;
    color: #a474ff;
    font-size: 1.1rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    box-shadow: 0 0 10px #8e44ad99;
    transition: background-color 0.3s ease;
  }
  #toggle-outstock:hover {
    background-color: #8e44ad44;
  }
  #content {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    max-width: 900px;
    margin: 0 auto;
  }
  .item {
    background: #1a0d38;
    border: 2px solid #8e44ad;
    padding: 1rem;
    border-radius: 10px;
    min-width: 160px;
    box-shadow: 0 0 12px #8e44ad99;
    user-select: none;
  }
  .item-name {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 0.3rem;
  }
  .in-stock {
    color: #7df57d;
    font-weight: bold;
  }
  .out-stock {
    color: #ff7777;
    font-style: italic;
  }
  #outstock-sidebar {
    position: fixed;
    right: 0;
    top: 0;
    height: 100vh;
    width: 280px;
    background: #1a0d38;
    border-left: 3px solid #8e44ad;
    padding: 1rem;
    overflow-y: auto;
    box-shadow: -4px 0 20px #8e44adcc;
    display: none;
    z-index: 900;
  }
  #outstock-sidebar h3 {
    margin-top: 0;
    color: #bb80ff;
    text-shadow: 0 0 8px #9b59b6;
    text-align: center;
    margin-bottom: 1rem;
  }
  #outstock-sidebar .item {
    margin-bottom: 0.7rem;
    font-style: italic;
    color: #ff7777;
  }
  /* Shake animation for warning */
  @keyframes shake {
    0%, 100% { transform: translateX(0) }
    20%, 60% { transform: translateX(-10px) }
    40%, 80% { transform: translateX(10px) }
  }
  body.shake {
    animation: shake 0.5s ease-in-out 3;
    background-color: #330000 !important;
  }
</style>
</head>
<body>
  <h1>🌱 Grow-A-Garden Tracker</h1>
  <div id="restock-timer">Loading...</div>

  <button id="toggle-outstock">Show Out of Stock</button>

  <div id="content">Fetching stock data...</div>

  <div id="outstock-sidebar" aria-label="Out of stock items">
    <h3>Out of Stock</h3>
    <div id="outstock-list"></div>
  </div>

<script>
  const API_URL = 'https://corsproxy.io/?https://gagstock.gleeze.com/grow-a-garden';

  const timerEl = document.getElementById('restock-timer');
  const contentEl = document.getElementById('content');
  const outstockSidebar = document.getElementById('outstock-sidebar');
  const outstockList = document.getElementById('outstock-list');
  const toggleOutstockBtn = document.getElementById('toggle-outstock');

  let liveSeconds = 0;
  let allSeeds = [];
  let allGear = [];
  let outstockVisible = false;

  const rareSeeds = new Set([
    "Beanstalk",
    "Ember Lily",
    "Sugar Apple",
    "Burning Bud"
  ]);

  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }

  function secToHMS(sec) {
    sec = Math.max(0, sec);
    const h = String(Math.floor(sec / 3600)).padStart(2, '0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  async function fetchData() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      return json.data;
    } catch (err) {
      console.error('API error:', err);
      timerEl.textContent = '⚠️ API Error';
      return null;
    }
  }

  function notify(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, { body, icon: '' });
    }
  }

  function shakeScreen() {
    if (!document.body.classList.contains('shake')) {
      document.body.classList.add('shake');
      setTimeout(() => {
        document.body.classList.remove('shake');
      }, 1500);
    }
  }

  function renderMainItems(seeds, gear) {
    const combined = [...seeds, ...gear];
    const inStockItems = combined.filter(i => i.quantity > 0);

    if (inStockItems.length === 0) {
      contentEl.innerHTML = '<em>No items currently in stock.</em>';
      return;
    }

    contentEl.innerHTML = inStockItems.map(i => `
      <div class="item">
        <div class="item-name">${i.name}</div>
        <div class="in-stock">In stock x${i.quantity}</div>
      </div>
    `).join('');
  }

  function renderOutstockSidebar(seeds, gear) {
    const combined = [...seeds, ...gear];
    const outstockItems = combined.filter(i => i.quantity === 0);
    if (outstockItems.length === 0) {
      outstockList.innerHTML = '<em>No out of stock items.</em>';
      return;
    }
    outstockList.innerHTML = outstockItems.map(i => `
      <div class="item">${i.name}</div>
    `).join('');
  }

  // Track which rare seeds were notified already so no repeats
  const notifiedRareSeeds = new Set();

  function checkRareSeeds(seeds) {
    seeds.forEach(seed => {
      if (rareSeeds.has(seed.name) && seed.quantity > 0 && !notifiedRareSeeds.has(seed.name)) {
        notify('Rare seed in stock!', `${seed.name} is available now!`);
        shakeScreen();
        notifiedRareSeeds.add(seed.name);
      }
      // Remove from set if out of stock to allow future notifications
      if (rareSeeds.has(seed.name) && seed.quantity === 0) {
        notifiedRareSeeds.delete(seed.name);
      }
    });
  }

  async function update() {
    const data = await fetchData();
    if (!data) return;

    allSeeds = data.seed?.items || [];
    allGear = data.gear?.items || [];

    const allItems = [...allSeeds, ...allGear];
    const times = allItems
      .map(i => i.restock_seconds)
      .filter(t => typeof t === 'number' && t >= 0);
    liveSeconds = times.length ? Math.min(...times) : 0;
    timerEl.textContent = secToHMS(liveSeconds);

    renderMainItems(allSeeds, allGear);

    if (outstockVisible) {
      renderOutstockSidebar(allSeeds, allGear);
      outstockSidebar.style.display = 'block';
    } else {
      outstockSidebar.style.display = 'none';
    }

    checkRareSeeds(allSeeds);
  }

  setInterval(() => {
    liveSeconds = Math.max(0, liveSeconds - 1);
    timerEl.textContent = secToHMS(liveSeconds);
  }, 1000);

  setInterval(update, 10000);
  update();

  toggleOutstockBtn.addEventListener('click', () => {
    outstockVisible = !outstockVisible;
    toggleOutstockBtn.textContent = outstockVisible ? 'Hide Out of Stock' : 'Show Out of Stock';
    if (outstockVisible) renderOutstockSidebar(allSeeds, allGear);
    outstockSidebar.style.display = outstockVisible ? 'block' : 'none';
  });
</script>
</body>
</html>
