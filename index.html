<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow-A-Garden Tracker</title>
  <style>
    body {
      background-color: #000;
      color: #a474ff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      color: #bb80ff;
      text-shadow: 0 0 8px #9b59b6;
    }
    #restock-timer, #since-restock-timer {
      font-size: 1.5rem;
      margin: 1rem 0;
    }
    .item {
      margin: 0.5rem auto;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      width: fit-content;
    }
    .in-stock { color: #7df57d; background: #133d13; }
    .out-stock { color: #ff7777; background: #3d1313; }
    #content, #out-stock-list {
      max-width: 600px;
      margin: 1rem auto;
      text-align: left;
    }
    #toggle-out-stock {
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background: #4a148c;
      color: white;
      cursor: pointer;
    }
    #last-updated {
      font-size: 0.9rem;
      margin-top: 1rem;
      color: #cfaaff;
    }
    #error {
      color: #ff4444;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <h1>üå± Grow-A-Garden Tracker</h1>
  <div id="restock-timer">Loading...</div>
  <div id="since-restock-timer"></div>

  <button id="toggle-out-stock">Show Out-of-Stock Items</button>

  <div id="content">Loading...</div>
  <div id="out-stock-list" style="display: none;"></div>

  <div id="last-updated"></div>
  <div id="error"></div>

  <script>
    const API = 'https://corsproxy.io/?https://gagstock.gleeze.com/grow-a-garden';

    const RARE = new Set(["Beanstalk", "Ember Lily", "Sugar Apple", "Burning Bud", "Blueberry"]);
    const FIXED_SEEDS = ["Carrot", "Strawberry", "Blueberry", "Orange Tulip", "Tomato", "Daffodil", "Watermelon", "Pumpkin", "Apple", "Bamboo", "Coconut", "Cactus", "Dragon Fruit", "Mango", "Grape", "Mushroom", "Pepper", "Cacao", "Beanstalk", "Ember Lily", "Sugar Apple", "Burning Bud"];
    const FIXED_GEAR = ["Master Sprinkler", "Cleaning Spray", "Favorite Tool", "Harvest Tool", "Friendship Pot", "Godly Sprinkler", "Advanced Sprinkler", "Basic Sprinkler", "Trowel", "Recall Wrench", "Watering Can"];

    const restockEl = document.getElementById('restock-timer');
    const sinceRestockEl = document.getElementById('since-restock-timer');
    const contentEl = document.getElementById('content');
    const outStockEl = document.getElementById('out-stock-list');
    const lastUpdatedEl = document.getElementById('last-updated');
    const toggleOutBtn = document.getElementById('toggle-out-stock');
    const errorEl = document.getElementById('error');

    let lastSeen = JSON.parse(localStorage.getItem('lastSeen') || '{}');
    let notified = new Set();
    let currentData = null;
    let restockSeconds = 0;
    let lastUpdateTime = Date.now();
    let sinceRestockStart = null;
    let showOut = false;

    toggleOutBtn.onclick = () => {
      showOut = !showOut;
      outStockEl.style.display = showOut ? 'block' : 'none';
      toggleOutBtn.textContent = showOut ? 'Hide Out-of-Stock Items' : 'Show Out-of-Stock Items';
    };

    function timeAgo(ts) {
      if (!ts) return 'never';
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return `${s}s ago`;
      if (s < 3600) return `${Math.floor(s / 60)}m ago`;
      return `${Math.floor(s / 3600)}h ago`;
    }

    function formatHMS(s) {
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h ? h + 'h ' : ''}${m ? m + 'm ' : ''}${sec}s`;
    }

    function updateSinceRestock() {
      if (!sinceRestockStart) {
        sinceRestockEl.textContent = '';
        return;
      }
      const elapsed = Math.floor((Date.now() - sinceRestockStart) / 1000);
      sinceRestockEl.textContent = `üïí Since restock: ${formatHMS(elapsed)}`;
    }

    function updateLastSeen(category, items) {
      const now = Date.now();
      items.forEach(i => {
        const key = category + ':' + i.name;
        if (i.quantity > 0) {
          lastSeen[key] = now;
        } else if (!lastSeen[key]) {
          lastSeen[key] = null;
        }
      });
      localStorage.setItem('lastSeen', JSON.stringify(lastSeen));
    }

    function showNotification(i) {
      if (Notification.permission === 'granted') {
        new Notification('üåü Rare Seed Alert', {
          body: `${i.name} is in stock (x${i.quantity})!`,
          icon: 'https://em-content.zobj.net/source/twitter/376/glowing-star_1f31f.png'
        });
      }
    }

    function render(data) {
      if (!data) return;

      const seedItems = data.seed?.items || [];
      const seedMap = new Map(seedItems.map(i => [i.name, i]));
      const combined = FIXED_SEEDS.map(name => {
        const i = seedMap.get(name);
        return { name, quantity: i ? i.quantity : 0 };
      });

      updateLastSeen('seed', combined);

      const inStock = combined.filter(i => i.quantity > 0);
      const outStock = combined.filter(i => i.quantity <= 0);

      contentEl.innerHTML = inStock.map(i =>
        `<div class="item in-stock">${i.name} ‚úÖ x${i.quantity}</div>`
      ).join('') || '<div>No items in stock.</div>';

      outStockEl.innerHTML = outStock.map(i => {
        const last = lastSeen['seed:' + i.name];
        return `<div class="item out-stock">${i.name} ‚ùå Last seen ${timeAgo(last)}</div>`;
      }).join('');

      seedItems.forEach(i => {
        if (RARE.has(i.name) && i.quantity > 0 && !notified.has(i.name)) {
          showNotification(i);
          notified.add(i.name);
        }
      });

      const estTime = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      }).format(new Date(data.updated_at || Date.now()));

      lastUpdatedEl.textContent = `Updated at ${estTime} EST`;
    }

    async function fetchData() {
      try {
        errorEl.textContent = '';
        const res = await fetch(API);
        if (!res.ok) throw new Error('Failed response');
        const json = await res.json();
        return json.data;
      } catch (err) {
        errorEl.textContent = '‚ö†Ô∏è Error loading stock data.';
        return null;
      }
    }

    function getRestockSeconds(data) {
      const times = (data.seed?.items || [])
        .filter(i => typeof i.restock_seconds === 'number')
        .map(i => i.restock_seconds);
      return times.length ? Math.min(...times) : 0;
    }

    async function refreshData() {
      const data = await fetchData();
      if (!data) return;

      const prevSeconds = restockSeconds;
      restockSeconds = getRestockSeconds(data);
      lastUpdateTime = Date.now();

      if (prevSeconds > 0 && restockSeconds === 0) {
        sinceRestockStart = Date.now();
      } else if (restockSeconds > 0) {
        sinceRestockStart = null;
      }

      currentData = data;
      render(data);
    }

    function tick() {
      const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
      const remaining = restockSeconds - elapsed;
      restockEl.textContent = remaining > 0
        ? `‚è≥ Next restock in: ${formatHMS(remaining)}`
        : `üü¢ Restocking...`;

      updateSinceRestock();

      if (remaining <= 0 && Date.now() - lastUpdateTime > 5000) {
        refreshData();
      }
    }

    async function startApp() {
      if (Notification.permission === 'default') {
        await Notification.requestPermission();
      }
      await refreshData();
      setInterval(tick, 1000);
    }

    startApp();
  </script>

</body>
</html>
