<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow-A-Garden Tracker</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  body {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: #e0e0e0;
    font-family: 'Montserrat', sans-serif;
    margin: 0;
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    transition: background-color 0.3s ease;
  }
  h1 {
    font-weight: 700;
    color: #9b59b6;
    margin-bottom: 0.2rem;
    text-shadow: 0 0 8px #8e44adaa;
  }
  #restock-timer {
    font-size: 3rem;
    font-weight: 700;
    color: #8e44ad;
    text-shadow: 0 0 12px #a64ca6cc;
    margin-bottom: 2rem;
    min-width: 280px;
    text-align: center;
  }
  #buttons {
    margin-bottom: 2rem;
  }
  button {
    background: transparent;
    border: 2px solid #9b59b6;
    color: #bb86fc;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0.6rem 1.8rem;
    margin: 0 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 6px #7e3dbb33;
  }
  button:hover {
    background: #9b59b6;
    color: #fff;
    box-shadow: 0 0 18px #9b59b6cc;
  }
  button.active {
    background: #8e44ad;
    color: #fff;
    box-shadow: 0 0 24px #8e44adcc;
    border-color: #8e44ad;
  }
  #content {
    background: #222239cc;
    border-radius: 16px;
    box-shadow: 0 0 30px 5px #7e3dbb77;
    width: 100%;
    max-width: 640px;
    padding: 1rem 2rem;
    font-size: 1.15rem;
    user-select: none;
  }
  .item {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #4b3a71;
    padding: 0.7rem 0;
  }
  .item:last-child {
    border-bottom: none;
  }
  .in-stock {
    color: #58d68d;
    font-weight: 700;
  }
  .out-stock {
    color: #e74c3c;
    font-style: italic;
  }
  #last-updated {
    margin-top: 1.4rem;
    font-size: 0.95rem;
    font-style: italic;
    text-align: center;
    color: #b294d9cc;
    user-select: none;
  }
  /* Shake animation */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-12px); }
    40%, 80% { transform: translateX(12px); }
  }
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  /* Red flash */
  .flash-red {
    background-color: #7e1a1a !important;
    transition: background-color 0.3s ease;
  }
</style>
</head>
<body>

<h1>üå± Grow-A-Garden Tracker</h1>
<div id="restock-timer">Loading restock timer...</div>

<div id="buttons">
  <button id="btn-seeds" class="active">Seeds</button>
  <button id="btn-gear">Gear</button>
</div>

<div id="content">Loading...</div>
<div id="last-updated"></div>

<script>
  const API_URL = 'https://gagstock.gleeze.com/grow-a-garden'; // Replace with your actual endpoint
  const FETCH_INTERVAL = 1000;

  const RARE_ITEMS = new Set([
    "Beanstalk",
    "Ember Lily",
    "Sugar Apple",
    "Burning Bud",
    "Blueberry"
  ]);

  const FIXED_GEAR = [
    "Master Sprinkler",
    "Cleaning Spray",
    "Favorite Tool",
    "Harvest Tool",
    "Friendship Pot",
    "Godly Sprinkler",
    "Advanced Sprinkler",
    "Basic Sprinkler",
    "Trowel",
    "Recall Wrench",
    "Watering Can"
  ];
  const FIXED_SEEDS = [
    "Carrot","Strawberry","Blueberry","Orange Tulip","Tomato","Daffodil","Watermelon",
    "Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape",
    "Mushroom","Pepper","Cacao","Beanstalk","Ember Lily","Sugar Apple","Burning Bud"
  ];

  let notifiedItems = new Set();
  let lastSeenTimestamps = JSON.parse(localStorage.getItem('lastSeen') || '{}');

  const contentEl = document.getElementById('content');
  const lastUpdatedEl = document.getElementById('last-updated');
  const restockTimerEl = document.getElementById('restock-timer');
  const btnSeeds = document.getElementById('btn-seeds');
  const btnGear = document.getElementById('btn-gear');

  let currentCategory = 'seed';
  let currentData = null;

  btnSeeds.onclick = () => {
    currentCategory = 'seed';
    btnSeeds.classList.add('active');
    btnGear.classList.remove('active');
    render(currentData);
  };

  btnGear.onclick = () => {
    currentCategory = 'gear';
    btnGear.classList.add('active');
    btnSeeds.classList.remove('active');
    render(currentData);
  };

  function timeAgo(ts) {
    if (!ts) return 'never';
    const seconds = Math.floor((Date.now() - ts) / 1000);
    if (seconds < 60) return seconds + 's ago';
    if (seconds < 3600) return Math.floor(seconds/60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds/3600) + 'h ago';
    return Math.floor(seconds/86400) + 'd ago';
  }

  function formatTimeLeft(seconds) {
    if (seconds <= 0) return "Restocking now";
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    if (m > 0) return `${m}m ${s}s until restock`;
    return `${s}s until restock`;
  }

  function updateLastSeen(category, items) {
    const now = Date.now();
    items.forEach(item => {
      if (item.quantity > 0) {
        lastSeenTimestamps[category + ':' + item.name] = now;
      } else if (!lastSeenTimestamps[category + ':' + item.name]) {
        lastSeenTimestamps[category + ':' + item.name] = null;
      }
    });
    localStorage.setItem('lastSeen', JSON.stringify(lastSeenTimestamps));
  }

  function triggerWarning() {
    document.body.classList.add('flash-red', 'shake');
    setTimeout(() => {
      document.body.classList.remove('shake');
    }, 500);
    setTimeout(() => {
      document.body.classList.remove('flash-red');
    }, 1000);
  }

  function showNotification(item) {
    if (Notification.permission === 'granted') {
      new Notification('üåü Rare Seed Alert', {
        body: `${item.name} is in stock! (x${item.quantity})`,
        icon: 'https://em-content.zobj.net/source/twitter/376/glowing-star_1f31f.png'
      });
    }
    triggerWarning();
  }

  function checkNotifications(data) {
    if (!data) return;
    const group = data[currentCategory];
    if (!group) return;

    group.items.forEach(item => {
      if (RARE_ITEMS.has(item.name) && item.quantity > 0 && !notifiedItems.has(item.name)) {
        showNotification(item);
        notifiedItems.add(item.name);
      }
    });
  }

  function getNextRestockSeconds(data) {
    if (!data) return null;
    let times = [];
    ['seed','gear'].forEach(cat => {
      if (data[cat]?.items) {
        data[cat].items.forEach(i => {
          if (typeof i.restock_seconds === 'number' && i.restock_seconds > 0) {
            times.push(i.restock_seconds);
          }
        });
      }
    });
    if (times.length === 0) return null;
    return Math.min(...times);
  }

  function render(data) {
    if (!data) {
      contentEl.textContent = 'Failed to load stock.';
      restockTimerEl.textContent = '';
      return;
    }
    currentData = data;

    const nextRestock = getNextRestockSeconds(data);
    if (nextRestock !== null) {
      restockTimerEl.textContent = formatTimeLeft(nextRestock);
    } else {
      restockTimerEl.textContent = 'No upcoming restocks';
    }

    let itemsToShow = [];
    if (currentCategory === 'gear') {
      const gearItems = data.gear?.items || [];
      const gearMap = new Map(gearItems.map(i => [i.name, i]));
      itemsToShow = FIXED_GEAR.map(name => {
        const item = gearMap.get(name);
        return {
          name,
          quantity: item ? item.quantity : 0,
        };
      });
    } else {
      const seedItems = data.seed?.items || [];
      const seedMap = new Map(seedItems.map(i => [i.name, i]));
      itemsToShow = FIXED_SEEDS.map(name => {
        const item = seedMap.get(name);
        return {
          name,
          quantity: item ? item.quantity : 0,
        };
      });
    }

    updateLastSeen(currentCategory, itemsToShow);

    contentEl.innerHTML = itemsToShow.map(item => {
      if (item.quantity > 0) {
        return `<div class="item in-stock">${item.name} <span>‚úÖ In stock x${item.quantity}</span></div>`;
      } else {
        const last = lastSeenTimestamps[currentCategory + ':' + item.name];
        return `<div class="item out-stock">${item.name} <span>‚ùå Out of stock (last seen ${timeAgo(last)})</span></div>`;
      }
    }).join('');

    lastUpdatedEl.textContent = 'Last updated: ' + new Date(data.updated_at || Date.now()).toLocaleTimeString();

    checkNotifications(data);
  }

  async function fetchData() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const json = await res.json();
      return json.data;
    } catch (e) {
      console.error('Error fetching stock:', e);
      return null;
    }
  }

  async function start() {
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      await Notification.requestPermission();
    }
    async function update() {
      const data = await fetchData();
      render(data);
    }
    await update();
    setInterval(update, FETCH_INTERVAL);
  }

  start();
</script>
</body>
</html>
